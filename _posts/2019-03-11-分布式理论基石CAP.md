---
layout: post
title:  "分布式理论基石CAP"
date:   2019-03-11 9:41:01 +0800
categories: 杂谈
tag: 分布式
---

* content
{:toc}

在进行一些分布式系统的组件的选型的时候，我们常常需要关注的一个点是这个组件是AP的还是CP的。那么CAP到底是什么呢？

## CAP是什么
顾名思义，我们先翻译一下CAP的意思
- C:Consistent 一致性
- A:Available 可用性
- P:Partition tolerance 分区容错性

1998年，加州大学的计算机科学家 Eric Brewer 提出，分布式系统有上述三个指标，并且系统无法同时做到CAP.
大白话就是你想要 系统做到一致性 ，可用性，和分区容错性是不可能的，你必须抛弃其中一个。
我们的系统现在一般都是分布式的，就是都是分区容错的。那么，我们只能在 A 和 C之间进行选择。
### Consistent 一致性
一致性是什么呢，简单来说，就是在分布式系统中，写入一个V值后，系统内的读操作都返回V值。
#### 最终一致性
如果写入一个V值,K值,S值，在一段时间内读操作并不是正确的返回V,K,S值，但是在固定的一段时间后，能返回最终的S值,这种情况就叫最终一致性。就是最后的结果是正确的
也可以简单的理解为在一段时间后，节点间的数据会最终达到一致状态
### Available 可用性
可用性是指，只要收到用户的请求，系统必须给出响应。
### Partition tolerance 分区容错性
分区容错性是指，系统中的节点可能因为网络原因无法和其他集群节点通信，这时候系统还是不受影响的。

### 为什么我们只能在AC之间进行选择
因为分布式系统中，会出现网络无法通信的情况。
如果要保证一致性，那么就要在写入V值的时候，锁住当前写服务，打开往其他节点的链接，然后写入其他节点这个值。这时候系统服务是不可用的。
如果要保证可用性，那么就不能在写入的时候，通知其他节点。那么这时候不是节点不是一致的。

## CAP如何指导我们的系统设计工作
dubbo的注册中心是dubbo，大家都知道。zk真的合适做注册中心么？
zk的本质上是一个共识达成解决者。他解决在分布式环境下的同步协调问题（保证写入zk的数据在分布式环境下一致）。他是CP类型的。选择zk做服务发现可以是可以。但是有一个问题，
就是zk的集群是如果宕机超过了一半，那么就会导致zk的服务不可用。这对于服务发现来说，是致命的。

所以，在我们的系统设计的时候，应该仔细根据业务去考虑 我们需要 C还是A. 然后选择对应的 CP还是CA的中间件。

## CAP理论实践中的一些误区
- 系统是CP 或者 系统是 AP
这是错误的，CAP并不是整个系统的属性，而是系统的一些数据的属性。譬如余额系统里边的余额，在网络没有分区的时候，是CA的。
如果一旦发生网络分区，必须是CP的。
举个例子，用户在A数据中心存了100元，由于发生了网络分区，去B数据中心发现自己的余额是0元。这时候用户就慌了。这时候的可用性对于用户来说，还不如不可用。应该告诉用户，网络出现了问题，
余额不对不要慌，很快会恢复。
但是你说登录数据也必须是CP的，那么A中心登录成功，到了B中心由于不一致，你不让用户登录，那就影响到一大片用户了。这时候登录数据是AP的。

- 分布式系统不可能做到CA
错误的，在发生了网络分区的情况下才做不到CA. 正常情况下是CA的。

- 因为发生了分区，做不到CA,只能完全抛弃 C或者 抛弃A
错误的，譬如你选择A,那么C可以通过一些延时的操作来达到，譬如消息队列，更有甚者是人工干预。 
AP情况下的延伸就是BASE理论，1.基本可用 2软状态 3最终一致性